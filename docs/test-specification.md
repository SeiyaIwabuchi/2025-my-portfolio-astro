# E2Eテスト仕様書

## 概要

本ポートフォリオサイトのE2E（End-to-End）テスト仕様書です。機能テストとビジュアルリグレッションテストの2つのカテゴリでテストを実施します。

## テスト環境

### 対象ブラウザ
- **Chromium** (デスクトップ)
- **Mobile Chrome** (モバイル)
- **Mobile Safari** (モバイル)

### 実行前提条件
- 開発サーバーが起動していること (`npm run dev`)
- ローカル環境: `http://localhost:4321`

## テストファイル構成

### 1. baseline.spec.ts（機能テスト）
ユーザーの実際の操作を模擬した機能確認テスト

### 2. simple-baseline.spec.ts（ビジュアルリグレッションテスト）
スクリーンショット比較による視覚的変更検出テスト

---

## 機能テスト詳細（baseline.spec.ts）

### 🏠 ホームページ - ベースライン動作確認

#### TC001: ページが正常に読み込まれること
- **目的**: 基本要素の表示確認
- **手順**:
  1. モバイルサイズ（375x667）に設定
  2. ホームページにアクセス
  3. ページタイトルに「Portfolio」が含まれることを確認
  4. メインナビゲーション、ハンバーガーボタン、モバイルメニューの存在を確認

#### TC002: デスクトップナビゲーションが正しく表示されること
- **目的**: デスクトップ環境でのナビゲーション表示確認
- **手順**:
  1. デスクトップサイズ（1920x1080）に設定
  2. ホームページにアクセス
  3. デスクトップナビゲーション内の全リンクが表示されることを確認
    - 自己紹介 (`/about`)
    - スキル (`/skills`)
    - 実績 (`/works`)
    - 職歴 (`/experience`)
    - お問い合わせ (`/contact`)
  4. ロゴリンクが表示され「Portfolio」テキストを含むことを確認
  5. ハンバーガーボタンが非表示であることを確認

### 📱 モバイル表示とメニュー操作

#### TC003: モバイルでハンバーガーボタンが表示されること
- **目的**: モバイル環境でのハンバーガーボタン表示確認
- **手順**:
  1. モバイルサイズ（375x667）に設定
  2. ホームページにアクセス
  3. ハンバーガーボタンが表示されることを確認
  4. ARIA属性の確認
    - `aria-expanded="false"`
    - `aria-label="メニューを開く"`

#### TC004: モバイルメニューの開閉動作
- **目的**: モバイルメニューの開閉機能確認
- **手順**:
  1. モバイルサイズに設定
  2. 初期状態でメニューが閉じていることを確認
  3. ハンバーガーボタンをクリック
  4. メニューが開いた状態を確認
    - メニューに`open`クラスが付与される
    - `aria-expanded="true"`に変更される
    - ハンバーガーボタンに`active`クラスが付与される
  5. ハンバーガーアイコンのアニメーション確認

#### TC005: ESCキーでメニューが閉じること
- **目的**: キーボード操作でのメニュー制御確認
- **手順**:
  1. モバイルメニューを開く
  2. ESCキーを押下
  3. メニューが閉じることを確認

#### TC006: メニューリンクをクリックでメニューが閉じること
- **目的**: メニューリンククリック時の自動クローズ確認
- **手順**:
  1. モバイルメニューを開く
  2. メニュー内の「自己紹介」リンクをクリック
  3. `/about`ページに遷移することを確認
  4. 新しいページでメニューが閉じていることを確認

### 🔗 ページ遷移とナビゲーション

#### TC007-TC011: 各ページが正常に表示されること
各ページ（自己紹介、スキル、実績、職歴、お問い合わせ）について以下を確認

- **目的**: 全ページの基本機能確認
- **手順**:
  1. 対象ページにアクセス
  2. ネットワーク読み込み完了を待機
  3. ローディングスピナーが非表示になることを確認
  4. ナビゲーションが表示されることを確認
  5. 現在のページリンクがアクティブ状態であることを確認

**対象ページ**:
- TC007: 自己紹介ページ (`/about`)
- TC008: スキルページ (`/skills`)
- TC009: 実績ページ (`/works`)
- TC010: 職歴ページ (`/experience`)
- TC011: お問い合わせページ (`/contact`)

### 🖥️ レスポンシブ表示確認

#### TC012-TC015: 各ビューポートでレイアウトが崩れないこと
- **目的**: レスポンシブデザインの確認
- **ビューポート**:
  - TC012: Desktop (1920x1080)
  - TC013: Tablet (768x1024)
  - TC014: Mobile (375x667)
  - TC015: Mobile Small (320x568)

- **手順**:
  1. 指定ビューポートに設定
  2. ホームページにアクセス
  3. ナビゲーションが表示されることを確認
  4. ビューポートに応じた表示の確認
    - 768px以上: デスクトップナビ表示、ハンバーガーボタン非表示
    - 768px未満: ハンバーガーボタン表示

### ♿ アクセシビリティ確認

#### TC016: キーボードナビゲーションが機能すること
- **目的**: キーボード操作によるナビゲーション確認
- **手順**:
  1. ホームページにアクセス
  2. Tabキーを押下
  3. フォーカスが適切な要素（A、BUTTON）に移動することを確認

#### TC017: ARIA属性が適切に設定されていること
- **目的**: スクリーンリーダー対応の確認
- **手順**:
  1. モバイルサイズでホームページにアクセス
  2. ハンバーガーボタンの初期ARIA属性を確認
    - `aria-expanded="false"`
    - `aria-label="メニューを開く"`
  3. メニューを開く
  4. 変更後のARIA属性を確認
    - `aria-expanded="true"`
    - `aria-label="メニューを閉じる"`

---

## ビジュアルリグレッションテスト詳細（simple-baseline.spec.ts）

### 📸 ベースライン・スクリーンショット生成

#### VT001: ホームページ - デスクトップ
- **目的**: デスクトップ版ホームページの視覚的確認
- **条件**: Chromiumプロジェクトでのみ実行
- **手順**:
  1. ビューポート設定: 1920x1080
  2. ホームページにアクセス
  3. 段階的スクロール（10ステップ、200ms間隔）でアニメーション発火
  4. 最上部に戻る（5ステップ、100ms間隔）
  5. フルページスクリーンショット撮影
- **許容差異**: 30%（threshold: 0.3）

#### VT002: ホームページ - モバイル
- **目的**: モバイル版ホームページの視覚的確認
- **条件**: mobile-chromeとmobile-safariで実行
- **手順**:
  1. ビューポート設定: 375x667
  2. ホームページにアクセス
  3. 段階的スクロール（8ステップ、150ms間隔）でアニメーション発火
  4. 最上部に戻る（4ステップ、100ms間隔）
  5. フルページスクリーンショット撮影
- **許容差異**: 30%（threshold: 0.3）

#### VT003: モバイルメニュー - 開いた状態
- **目的**: モバイルメニュー表示時の視覚的確認
- **条件**: mobile-chromeとmobile-safariで実行
- **手順**:
  1. ビューポート設定: 375x667
  2. ホームページにアクセス
  3. ハンバーガーボタンをクリック
  4. アニメーション完了待機（1000ms）
  5. フルページスクリーンショット撮影
- **許容差異**: 30%（threshold: 0.3）

#### VT004-VT008: 各ページ - デスクトップ版
- **目的**: 全ページのデスクトップ版視覚的確認
- **条件**: Chromiumプロジェクトでのみ実行
- **対象ページ**: about、skills、works、experience、contact
- **手順**:
  1. ビューポート設定: 1920x1080
  2. 対象ページにアクセス
  3. 段階的スクロールでアニメーション発火
  4. 最上部に戻る
  5. フルページスクリーンショット撮影
- **許容差異**: 50%（threshold: 0.5）

#### VT009-VT013: 各ページ - モバイル版
- **目的**: 全ページのモバイル版視覚的確認
- **条件**: mobile-chromeとmobile-safariで実行
- **対象ページ**: about、skills、works、experience、contact
- **手順**:
  1. ビューポート設定: 375x667
  2. 対象ページにアクセス
  3. 段階的スクロール（6ステップ、120ms間隔）でアニメーション発火
  4. 最上部に戻る（3ステップ、80ms間隔）
  5. フルページスクリーンショット撮影
- **許容差異**: 50%（Safari対応、threshold: 0.5）

---

## テスト実行コマンド

### 基本コマンド

```powershell
# 全テスト実行（機能テスト + ビジュアルリグレッション）
npm run test:e2e

# Chromiumのみでテスト実行
npm run test:e2e:chromium

# ベースライン画像更新
npm run test:baseline

# UIモードでテスト実行
npm run test:e2e:ui

# デバッグモード
npm run test:e2e:debug

# ヘッドモード（ブラウザ表示）
npm run test:e2e:headed
```

### 個別テスト実行

```powershell
# 機能テストのみ
npx playwright test baseline.spec.ts

# ビジュアルリグレッションテストのみ
npx playwright test simple-baseline.spec.ts

# 特定のテストケース
npx playwright test -g "モバイルメニューの開閉動作"
```

---

## ベースライン画像管理

### 保存場所
```
tests/e2e/simple-baseline.spec.ts-snapshots/
├── chromium/
│   ├── homepage-desktop.png
│   ├── about-page-desktop.png
│   ├── skills-page-desktop.png
│   ├── works-page-desktop.png
│   ├── experience-page-desktop.png
│   └── contact-page-desktop.png
├── mobile-chrome/
│   ├── homepage-mobile.png
│   ├── mobile-menu-open.png
│   ├── about-page-mobile.png
│   ├── skills-page-mobile.png
│   ├── works-page-mobile.png
│   ├── experience-page-mobile.png
│   └── contact-page-mobile.png
└── mobile-safari/
    ├── homepage-mobile.png
    ├── mobile-menu-open.png
    ├── about-page-mobile.png
    ├── skills-page-mobile.png
    ├── works-page-mobile.png
    ├── experience-page-mobile.png
    └── contact-page-mobile.png
```

### 更新タイミング
- 初回ベースライン作成: `npm run test:baseline`
- デザイン変更時の更新: `npm run test:baseline`
- 意図しない変更検出時の確認: `npm run test:e2e`

---

## 既知の制限事項

### 1. フォント差異
- Safari（WebKit）とChromiumでフォントレンダリングが異なる
- mobile-safariでは許容差異を50%に設定して対応

### 2. アニメーション
- ページローディング後のアニメーション発火のため段階的スクロールを実装
- CSS `animations: 'disabled'`でアニメーションを無効化

### 3. ローディングスピナー
- Layout.astroで実装されたローディングスピナーの完了待機が必要
- `loading-spinner`要素に`hidden`クラス付与を待機

---

## トラブルシューティング

### 頻出エラーと対処法

1. **Element not visible**: モバイル環境でナビゲーション要素が隠れている
   - 解決: ハンバーガーメニューの開閉状態を確認

2. **Screenshot differences**: ビジュアルリグレッションで差異検出
   - 解決: 差分画像を確認し、意図的変更の場合はベースライン更新

3. **Timeout errors**: ページ読み込みタイムアウト
   - 解決: `waitForLoadState('networkidle')`の追加、待機時間の調整

4. **JavaScript errors**: page.evaluate内でのエラー
   - 解決: ブラウザコンテキストで利用可能なAPIのみ使用

---

## 更新履歴

| 日付 | 版数 | 変更内容 |
|------|------|----------|
| 2025-09-07 | 1.0 | 初版作成 |
